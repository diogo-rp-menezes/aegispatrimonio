<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pt"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AtivoService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">aegispatrimonio</a> &gt; <a href="index.source.html" class="el_package">br.com.aegispatrimonio.service</a> &gt; <span class="el_source">AtivoService.java</span></div><h1>AtivoService.java</h1><pre class="source lang-java linenums">package br.com.aegispatrimonio.service;

import br.com.aegispatrimonio.dto.AtivoCreateDTO;
import br.com.aegispatrimonio.dto.AtivoDTO;
import br.com.aegispatrimonio.dto.AtivoUpdateDTO;
import br.com.aegispatrimonio.mapper.AtivoMapper;
import br.com.aegispatrimonio.model.*;
import br.com.aegispatrimonio.repository.*;
import br.com.aegispatrimonio.security.CustomUserDetails;
import jakarta.persistence.EntityNotFoundException;
import org.springframework.security.access.AccessDeniedException;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.math.BigDecimal;
import java.time.LocalDate;
import java.util.List;
import java.util.Objects;
import java.util.Optional;
import java.util.Set;
import java.util.stream.Collectors;

@Service
public class AtivoService {

    private final AtivoRepository ativoRepository;
    private final AtivoMapper ativoMapper;
    private final TipoAtivoRepository tipoAtivoRepository;
    private final LocalizacaoRepository localizacaoRepository;
    private final FornecedorRepository fornecedorRepository;
    private final FuncionarioRepository funcionarioRepository;
    private final FilialRepository filialRepository;
    private final ManutencaoRepository manutencaoRepository;
    private final MovimentacaoRepository movimentacaoRepository;
    private final DepreciacaoService depreciacaoService;

<span class="fc" id="L38">    public AtivoService(AtivoRepository ativoRepository, AtivoMapper ativoMapper, TipoAtivoRepository tipoAtivoRepository, LocalizacaoRepository localizacaoRepository, FornecedorRepository fornecedorRepository, FuncionarioRepository funcionarioRepository, FilialRepository filialRepository, ManutencaoRepository manutencaoRepository, MovimentacaoRepository movimentacaoRepository, DepreciacaoService depreciacaoService) {</span>
<span class="fc" id="L39">        this.ativoRepository = ativoRepository;</span>
<span class="fc" id="L40">        this.ativoMapper = ativoMapper;</span>
<span class="fc" id="L41">        this.tipoAtivoRepository = tipoAtivoRepository;</span>
<span class="fc" id="L42">        this.localizacaoRepository = localizacaoRepository;</span>
<span class="fc" id="L43">        this.fornecedorRepository = fornecedorRepository;</span>
<span class="fc" id="L44">        this.funcionarioRepository = funcionarioRepository;</span>
<span class="fc" id="L45">        this.filialRepository = filialRepository;</span>
<span class="fc" id="L46">        this.manutencaoRepository = manutencaoRepository;</span>
<span class="fc" id="L47">        this.movimentacaoRepository = movimentacaoRepository;</span>
<span class="fc" id="L48">        this.depreciacaoService = depreciacaoService;</span>
<span class="fc" id="L49">    }</span>

    private Usuario getUsuarioLogado() {
<span class="fc" id="L52">        CustomUserDetails userDetails = (CustomUserDetails) SecurityContextHolder.getContext().getAuthentication().getPrincipal();</span>
<span class="fc" id="L53">        return userDetails.getUsuario();</span>
    }

    private boolean isAdmin(Usuario usuario) {
<span class="fc" id="L57">        return &quot;ROLE_ADMIN&quot;.equals(usuario.getRole());</span>
    }

    @Transactional(readOnly = true)
    public List&lt;AtivoDTO&gt; listarTodos() {
<span class="fc" id="L62">        Usuario usuarioLogado = getUsuarioLogado();</span>

<span class="fc bfc" id="L64" title="All 2 branches covered.">        if (isAdmin(usuarioLogado)) {</span>
<span class="fc" id="L65">            return ativoRepository.findAllWithDetails().stream().map(ativoMapper::toDTO).collect(Collectors.toList());</span>
        }

<span class="fc" id="L68">        Funcionario funcionarioPrincipal = usuarioLogado.getFuncionario();</span>
<span class="pc bpc" id="L69" title="2 of 4 branches missed.">        if (funcionarioPrincipal == null || funcionarioPrincipal.getId() == null) {</span>
<span class="nc" id="L70">            throw new AccessDeniedException(&quot;Usuário não é um funcionário ou não está associado a nenhuma filial.&quot;);</span>
        }

        // Recarrega o funcionário do banco para garantir as filiais carregadas
<span class="fc" id="L74">        Funcionario funcionarioLogado = funcionarioRepository.findById(funcionarioPrincipal.getId())</span>
<span class="pc" id="L75">                .orElseThrow(() -&gt; new AccessDeniedException(&quot;Funcionário associado ao usuário não foi encontrado.&quot;));</span>
<span class="pc bpc" id="L76" title="2 of 4 branches missed.">        if (funcionarioLogado.getFiliais() == null || funcionarioLogado.getFiliais().isEmpty()) {</span>
<span class="nc" id="L77">            throw new AccessDeniedException(&quot;Usuário não está associado a nenhuma filial.&quot;);</span>
        }

<span class="fc" id="L80">        Set&lt;Long&gt; filiaisIds = funcionarioLogado.getFiliais().stream().map(Filial::getId).collect(Collectors.toSet());</span>
        
        // CORREÇÃO: Usar findByFilialIdInWithDetails para evitar LazyInitializationException.
<span class="fc" id="L83">        return ativoRepository.findByFilialIdInWithDetails(filiaisIds).stream().map(ativoMapper::toDTO).collect(Collectors.toList());</span>
    }

    @Transactional(readOnly = true)
    public AtivoDTO buscarPorId(Long id) {
<span class="fc" id="L88">        Usuario usuarioLogado = getUsuarioLogado();</span>
<span class="fc" id="L89">        Ativo ativo = ativoRepository.findByIdWithDetails(id)</span>
<span class="fc" id="L90">                .orElseThrow(() -&gt; new EntityNotFoundException(&quot;Ativo não encontrado com ID: &quot; + id));</span>

<span class="pc bpc" id="L92" title="1 of 2 branches missed.">        if (!isAdmin(usuarioLogado)) {</span>
<span class="fc" id="L93">            Funcionario funcionarioPrincipal = usuarioLogado.getFuncionario();</span>
<span class="pc bpc" id="L94" title="2 of 4 branches missed.">            if (funcionarioPrincipal == null || funcionarioPrincipal.getId() == null) {</span>
<span class="nc" id="L95">                throw new AccessDeniedException(&quot;Usuário não é um funcionário ou não está associado a nenhuma filial.&quot;);</span>
            }
<span class="fc" id="L97">            Funcionario funcionarioLogado = funcionarioRepository.findById(funcionarioPrincipal.getId())</span>
<span class="fc" id="L98">                    .orElseThrow(() -&gt; new AccessDeniedException(&quot;Funcionário associado ao usuário não foi encontrado.&quot;));</span>
<span class="pc bpc" id="L99" title="1 of 2 branches missed.">            if (funcionarioLogado.getFiliais().stream().noneMatch(f -&gt; f.getId().equals(ativo.getFilial().getId()))) {</span>
<span class="nc" id="L100">                throw new AccessDeniedException(&quot;Você não tem permissão para acessar ativos desta filial.&quot;);</span>
            }
        }

<span class="fc" id="L104">        return ativoMapper.toDTO(ativo);</span>
    }

    @Transactional
    public AtivoDTO criar(AtivoCreateDTO ativoCreateDTO) {
<span class="fc" id="L109">        validarNumeroPatrimonio(ativoCreateDTO.numeroPatrimonio(), null);</span>

<span class="fc" id="L111">        Ativo ativo = new Ativo();</span>
<span class="fc" id="L112">        ativo.setNome(ativoCreateDTO.nome());</span>
<span class="fc" id="L113">        ativo.setNumeroPatrimonio(ativoCreateDTO.numeroPatrimonio());</span>
<span class="fc" id="L114">        ativo.setDataAquisicao(ativoCreateDTO.dataAquisicao());</span>
<span class="fc" id="L115">        ativo.setValorAquisicao(ativoCreateDTO.valorAquisicao());</span>
<span class="fc" id="L116">        ativo.setObservacoes(ativoCreateDTO.observacoes());</span>
<span class="fc" id="L117">        ativo.setInformacoesGarantia(ativoCreateDTO.informacoesGarantia());</span>

<span class="fc" id="L119">        Filial filial = filialRepository.findById(ativoCreateDTO.filialId())</span>
<span class="pc" id="L120">                .orElseThrow(() -&gt; new EntityNotFoundException(&quot;Filial não encontrada com ID: &quot; + ativoCreateDTO.filialId()));</span>
<span class="fc" id="L121">        ativo.setFilial(filial);</span>

<span class="fc" id="L123">        TipoAtivo tipoAtivo = tipoAtivoRepository.findById(ativoCreateDTO.tipoAtivoId())</span>
<span class="pc" id="L124">                .orElseThrow(() -&gt; new EntityNotFoundException(&quot;Tipo de Ativo não encontrado com ID: &quot; + ativoCreateDTO.tipoAtivoId()));</span>
<span class="fc" id="L125">        ativo.setTipoAtivo(tipoAtivo);</span>

<span class="fc" id="L127">        Fornecedor fornecedor = fornecedorRepository.findById(ativoCreateDTO.fornecedorId())</span>
<span class="pc" id="L128">                .orElseThrow(() -&gt; new EntityNotFoundException(&quot;Fornecedor não encontrado com ID: &quot; + ativoCreateDTO.fornecedorId()));</span>
<span class="fc" id="L129">        ativo.setFornecedor(fornecedor);</span>

<span class="pc bpc" id="L131" title="1 of 2 branches missed.">        if (ativoCreateDTO.localizacaoId() != null) {</span>
<span class="fc" id="L132">            Localizacao localizacao = localizacaoRepository.findById(ativoCreateDTO.localizacaoId())</span>
<span class="pc" id="L133">                    .orElseThrow(() -&gt; new EntityNotFoundException(&quot;Localização não encontrada com ID: &quot; + ativoCreateDTO.localizacaoId()));</span>
<span class="fc" id="L134">            validarConsistenciaLocalizacao(localizacao, filial);</span>
<span class="fc" id="L135">            ativo.setLocalizacao(localizacao);</span>
        }

<span class="pc bpc" id="L138" title="1 of 2 branches missed.">        if (ativoCreateDTO.funcionarioResponsavelId() != null) {</span>
<span class="fc" id="L139">            Funcionario responsavel = funcionarioRepository.findById(ativoCreateDTO.funcionarioResponsavelId())</span>
<span class="pc" id="L140">                    .orElseThrow(() -&gt; new EntityNotFoundException(&quot;Funcionário responsável não encontrado com ID: &quot; + ativoCreateDTO.funcionarioResponsavelId()));</span>
<span class="fc" id="L141">            validarConsistenciaResponsavel(responsavel, filial);</span>
<span class="fc" id="L142">            ativo.setFuncionarioResponsavel(responsavel);</span>
        }

<span class="fc" id="L145">        Ativo ativoSalvo = ativoRepository.save(ativo);</span>
        
<span class="fc" id="L147">        Ativo ativoCompleto = ativoRepository.findByIdWithDetails(ativoSalvo.getId())</span>
<span class="pc" id="L148">                .orElseThrow(() -&gt; new IllegalStateException(&quot;Ativo recém-criado não encontrado. ID: &quot; + ativoSalvo.getId()));</span>

<span class="fc" id="L150">        return ativoMapper.toDTO(ativoCompleto);</span>
    }

    @Transactional
    public AtivoDTO atualizar(Long id, AtivoUpdateDTO ativoUpdateDTO) {
<span class="fc" id="L155">        Ativo ativo = ativoRepository.findByIdWithDetails(id)</span>
<span class="fc" id="L156">                .orElseThrow(() -&gt; new EntityNotFoundException(&quot;Ativo não encontrado com ID: &quot; + id));</span>

<span class="fc" id="L158">        validarNumeroPatrimonio(ativoUpdateDTO.numeroPatrimonio(), id);</span>

<span class="fc" id="L160">        BigDecimal valorAquisicaoOriginal = ativo.getValorAquisicao();</span>
<span class="fc" id="L161">        LocalDate dataAquisicaoOriginal = ativo.getDataAquisicao();</span>

<span class="fc" id="L163">        ativo.setNome(ativoUpdateDTO.nome());</span>
<span class="fc" id="L164">        ativo.setNumeroPatrimonio(ativoUpdateDTO.numeroPatrimonio());</span>
<span class="fc" id="L165">        ativo.setStatus(ativoUpdateDTO.status());</span>
<span class="fc" id="L166">        ativo.setDataAquisicao(ativoUpdateDTO.dataAquisicao());</span>
<span class="fc" id="L167">        ativo.setValorAquisicao(ativoUpdateDTO.valorAquisicao());</span>
<span class="fc" id="L168">        ativo.setObservacoes(ativoUpdateDTO.observacoes());</span>
<span class="fc" id="L169">        ativo.setInformacoesGarantia(ativoUpdateDTO.informacoesGarantia());</span>

<span class="fc" id="L171">        Filial filial = filialRepository.findById(ativoUpdateDTO.filialId())</span>
<span class="pc" id="L172">                .orElseThrow(() -&gt; new EntityNotFoundException(&quot;Filial não encontrada com ID: &quot; + ativoUpdateDTO.filialId()));</span>
<span class="fc" id="L173">        ativo.setFilial(filial);</span>

<span class="fc" id="L175">        TipoAtivo tipoAtivo = tipoAtivoRepository.findById(ativoUpdateDTO.tipoAtivoId())</span>
<span class="pc" id="L176">                .orElseThrow(() -&gt; new EntityNotFoundException(&quot;Tipo de Ativo não encontrado com ID: &quot; + ativoUpdateDTO.tipoAtivoId()));</span>
<span class="fc" id="L177">        ativo.setTipoAtivo(tipoAtivo);</span>

<span class="fc" id="L179">        Fornecedor fornecedor = fornecedorRepository.findById(ativoUpdateDTO.fornecedorId())</span>
<span class="pc" id="L180">                .orElseThrow(() -&gt; new EntityNotFoundException(&quot;Fornecedor não encontrado com ID: &quot; + ativoUpdateDTO.fornecedorId()));</span>
<span class="fc" id="L181">        ativo.setFornecedor(fornecedor);</span>

<span class="pc bpc" id="L183" title="1 of 2 branches missed.">        if (ativoUpdateDTO.localizacaoId() != null) {</span>
<span class="fc" id="L184">            Localizacao localizacao = localizacaoRepository.findById(ativoUpdateDTO.localizacaoId())</span>
<span class="pc" id="L185">                    .orElseThrow(() -&gt; new EntityNotFoundException(&quot;Localização não encontrada com ID: &quot; + ativoUpdateDTO.localizacaoId()));</span>
<span class="fc" id="L186">            validarConsistenciaLocalizacao(localizacao, filial);</span>
<span class="fc" id="L187">            ativo.setLocalizacao(localizacao);</span>
<span class="fc" id="L188">        } else {</span>
<span class="nc" id="L189">            ativo.setLocalizacao(null);</span>
        }

<span class="pc bpc" id="L192" title="1 of 2 branches missed.">        if (ativoUpdateDTO.funcionarioResponsavelId() != null) {</span>
<span class="fc" id="L193">            Funcionario responsavel = funcionarioRepository.findById(ativoUpdateDTO.funcionarioResponsavelId())</span>
<span class="pc" id="L194">                    .orElseThrow(() -&gt; new EntityNotFoundException(&quot;Funcionário responsável não encontrado com ID: &quot; + ativoUpdateDTO.funcionarioResponsavelId()));</span>
<span class="fc" id="L195">            validarConsistenciaResponsavel(responsavel, filial);</span>
<span class="fc" id="L196">            ativo.setFuncionarioResponsavel(responsavel);</span>
<span class="fc" id="L197">        } else {</span>
<span class="nc" id="L198">            ativo.setFuncionarioResponsavel(null);</span>
        }

<span class="fc" id="L201">        Ativo ativoAtualizado = ativoRepository.save(ativo);</span>

<span class="pc bpc" id="L203" title="1 of 2 branches missed.">        boolean precisaRecalcular = !Objects.equals(valorAquisicaoOriginal, ativoUpdateDTO.valorAquisicao()) ||</span>
<span class="pc bpc" id="L204" title="1 of 2 branches missed.">                                  !Objects.equals(dataAquisicaoOriginal, ativoUpdateDTO.dataAquisicao());</span>

<span class="pc bpc" id="L206" title="1 of 2 branches missed.">        if (precisaRecalcular) {</span>
<span class="nc" id="L207">            depreciacaoService.recalcularDepreciacaoCompleta(ativoAtualizado.getId());</span>
        }
        
<span class="fc" id="L210">        return ativoMapper.toDTO(ativoAtualizado);</span>
    }

    @Transactional
    public void deletar(Long id) {
<span class="fc" id="L215">        Ativo ativo = ativoRepository.findById(id)</span>
<span class="fc" id="L216">                .orElseThrow(() -&gt; new EntityNotFoundException(&quot;Ativo não encontrado com ID: &quot; + id));</span>

<span class="fc bfc" id="L218" title="All 2 branches covered.">        if (manutencaoRepository.existsByAtivoId(id)) {</span>
<span class="fc" id="L219">            throw new IllegalStateException(&quot;Não é possível deletar o ativo, pois existem manutenções associadas a ele.&quot;);</span>
        }

<span class="fc bfc" id="L222" title="All 2 branches covered.">        if (movimentacaoRepository.existsByAtivoId(id)) {</span>
<span class="fc" id="L223">            throw new IllegalStateException(&quot;Não é possível deletar o ativo, pois existem movimentações associadas a ele.&quot;);</span>
        }

<span class="fc" id="L226">        ativoRepository.delete(ativo);</span>
<span class="fc" id="L227">    }</span>

    private void validarNumeroPatrimonio(String numeroPatrimonio, Long ativoId) {
<span class="fc" id="L230">        Optional&lt;Ativo&gt; ativoExistente = ativoRepository.findByNumeroPatrimonio(numeroPatrimonio);</span>
<span class="pc bpc" id="L231" title="1 of 4 branches missed.">        if (ativoExistente.isPresent() &amp;&amp; !ativoExistente.get().getId().equals(ativoId)) {</span>
<span class="nc" id="L232">            throw new IllegalArgumentException(&quot;Já existe um ativo cadastrado com o número de patrimônio informado.&quot;);</span>
        }
<span class="fc" id="L234">    }</span>

    private void validarConsistenciaLocalizacao(Localizacao localizacao, Filial filial) {
<span class="fc bfc" id="L237" title="All 2 branches covered.">        if (!localizacao.getFilial().getId().equals(filial.getId())) {</span>
<span class="fc" id="L238">            throw new IllegalArgumentException(&quot;A localização selecionada não pertence à filial do ativo.&quot;);</span>
        }
<span class="fc" id="L240">    }</span>

    private void validarConsistenciaResponsavel(Funcionario responsavel, Filial filial) {
<span class="fc" id="L243">        boolean responsavelPertenceAFilial = responsavel.getFiliais().stream()</span>
<span class="fc" id="L244">                .anyMatch(f -&gt; f.getId().equals(filial.getId()));</span>
<span class="fc bfc" id="L245" title="All 2 branches covered.">        if (!responsavelPertenceAFilial) {</span>
<span class="fc" id="L246">            throw new IllegalArgumentException(&quot;O responsável selecionado não pertence à filial do ativo.&quot;);</span>
        }
<span class="fc" id="L248">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>